#后端技术个人思考

##后端服务

​	互联网提供了多种多样的服务，除了`美图`,`摄影`这类主要功能在手机侧的`App`，大部分的服务，其主要处理逻辑在远程的服务器后端。

​	网购、聊天、协作办公、游戏等业务，其核心，均是对数据的处理。根据业务特点，不同业务对数据处理要求有所差异，最终也导致在架构上有所区别。

##服务接入

​	`远古时代`有telnet/ftp 等各种协议的网上服务，现在网上公开的服务大部分（游戏除外）是基于HTTP。因此服务接入主要涉及HTTP服务的接入。

1. Local DNS解析：使用http访问Web资源时，要通过DNS将域名翻译为IP，此时会涉及到DNS缓存、本地DNS解析、最近DNS节点解析。此处会涉及到`运营商`问题，经典的网通、电信就因此而来。此处会有DNS劫持问题。
2. Http DNS解析：由于DNS劫持对互联网业务的影响，演变出了基于HTTP的 httpdns 服务。可以解决本地DNS的劫持问题， 见[腾讯云DNS](https://cloud.tencent.com/product/hd) 。
3. 反向代理：外网服务完成解析后，拿到一个公网IP，发起请求。如果是资源，可能是CDN的节点响应；如果是服务，请求将通过网关(gateway)处理后，再转发到真实的处理服务器（RS）。对请求者而言，RS节点是不可见的。一般gateway 使用nginx 来做，并具备一定的负载均衡的能力。

##读服务

​	看新闻、浏览评论、查看商品详情，都是从远端服务器拉取某些信息，在App/Web 上呈现的一个过程，主要是`读服务`。

​	而从后端服务的角度来看，收到用户侧请求时，做认证、安全过滤（可以由统一网关处理），提取请求参数，从redis/kv/MySQL等存储中，或者另一些服务中，拉取相应数据，拼装响应请求包。并返回给用户。

​	读请求的主要指标有`响应延时`、`响应成功率`、`P99响应延时`，`P99响应成功率`等

​	数据可用性：对于非实时UGC更新的数据（IM消息、微博评论），可采用多副本、多地的方式容灾，当某一副本异常时，接入侧可将用户流量迁移至另一副本或另一城市 。即可满足一定的可用性。    随之而来的就是多个副本间的数据一致性问题。这里有CAP理论来阐述， 可用性与一致性之间要做一定的trade-off 。

​	多中心：为了提升读服务的成功率（包括后端故障、网络解析故障等），很多互联网商会将服务部署在多个中心，每个中心有完备的一套服务能力， 正常情况下均摊服务，当某一中心异常时，通过全局调度器（可能是改域名指向，或协议上做302，或者是Client侧逻辑下发策略）将异常流量切到另一中心。历史上也有主备的模式，但一般认为资源浪费，没有双活来的稳妥。   

​	由于流量切换，存活的节点压力一般会上升，此时会用到“故障通知” “用户告示” 的方式提示用户，并且柔性降级，将部分服务置为不可用，尽最大努力 保证核心服务的稳定性。



​	

##CDN
​	图片、视频、文章内容等静态数据，为了减少逻辑服务器压力，一般会推送到离用户最近的CDN节点，前端请求时，会直接从CDN拉取，CDN会有相应的数据过期、数据回源策略。CDN也是计算机里面拆分思想的一种体现，将频繁拉取、较少变更、可以提前部署的资源或数据提前放到靠近用户的节点，降低实际服务压力，减少用户使用延时，提升用户体验

​	CDN的引入，也导致了一些小问题。 假定目前有一个Web页面，里面引用了css/js 文件，后端有逻辑变更时，会涉及css/js 的变更。此时，由于浏览器、CDN有多层缓存，导致用户仍然拉取到旧版本的文件，因此变更不生效（对于紧急BUG修复，很致命）。因此，一般的作法是将资源文件全名添加上hash值，例如 xxx.md5.js  这样新版本的文件名与旧版本不一致，促使Client侧发起新的请求，CDN也会对应 回源拉取文件。



##写服务

##服务高可用

##缓存

​	计算机世界里面的很多问题，通过加一个中间层，就能缓解或解决。

​	cpu/mem/磁盘  访问速度、存储量有所差异。因此采用恰当的缓存机制，可以有效提高服务性能。

​	`hot key` `big key`  是缓存经常碰到的问题。  `数据淘汰`是缓存设计需要考虑的策略，一般会结合业务模式，抽象出多种淘汰策略，由业务选择使用。 常见的有`LRU` `FIFO` `多级缓存`等

例如MySQL的缓存数据，为了防止一次大表扫描导致所有缓存数据被换出， 设计了多级缓存。




##数据存储

##离线分析

##数据容灾

##数据备份



## 一个创业公司的后端设计

​	后端对用户看不见，摸不着，只有崩溃的时候才会有感知。 同样，对大部分的前端请求而言，后端只是隐藏在http url 一个逻辑概念，也不会直接所有后端产生交互。但后端又很重要，承载了所有的业务数据、用户信息、用户关系、历史行为、以及公司如何去盈利的支撑。 因此，我假定一个公司场景，来摸索一下后端要如何做才能适应业务以及业务变更。

### 场景一：电子商务

​	假定当前公司的目标是要做个`拼多多`，来分析下要做哪些事情

#### 账号管理

​	无论是公众号、独立App、小程序、第三方SaaS、Web侧，最终咱们都要通过恰当的方式接触用户。因此一定有一个`用户注册`,`用户登录`,`密码找回` 的基础流程

​	在前几年，一般的注册模式是基于邮件，目前一般是基于QQ/微信/手机号，尤其为了用户营销，一般会在注册阶段，或使用阶段要求用户绑定手机号，用户表结构设计可能如下

```sql
create table `users`{
`id`  INT UNSIGNED AUTO_INCREMENT, 
`userid`  INT UNSIGNED ,   //这里可能是内部分配的业务上的ID
`logintype`   INT NOT NULL,
`openid`      VARCHAR(100),
`phone`       VARCHAR(32) ,
`email`       VARCHAR(100),
`passhash`    VARCHAR(100),
`salt`        VARCHAR(100)
PRIMARY KEY(id,userid) 
}ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

​	登录： 用户填账号密码，则根据账号取出salt/passhash，对密码做hash 后，校验passhash是否正确，取到相应的`userid` 。若使用第三方登录，则主要走OAuth 流程，由第三方服务器校验成功后，处理回调，并拿到openid/token 等，  根据openid 取回`userid`。一般登录后，会写一份登录流水到消息队列，用于触发业务逻辑，如更新资产状态、实时更新推荐数据、更新监控DashBoard等。

​	注册：这里有个`重复放号` 的情况，在短时间内，可能将同一个openid 分配多个userid ，这个没必要走在DB里面设定UNIQUE 会降低性能 ，重复就重复了，短时间的重复放号对用户侧无感。但跨长时间的重复放号就是故障了，逻辑上要保障判断账号类型失败时，交由前端业务重复， 不应错误放号。

#### 商品列表+详情

​	既然是`拼多多`，那得卖东西吧， 得有一个`商品库`

```sql
create table `goods`{
`id`  INT UNSIGNED AUTO_INCREMENT, 
`goodsid`  INT UNSIGNED 
PRIMARY KEY(id) 
}ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

用户进入查看时，后端根据一定规则(LR算法、AI、配置、随机、最近上架、流量售卖等等)取到一系列的`goodsid`，拉取一些展示信息后，前端用于显示。一个简单的`feeds`流就生成了。

有了feed流后，自然就要进去看详情页，详情页呈现的内容多，包括商品标题、关键词、分类、价格、数量、历史成交信息、信誉。以及最主要的图文详情内容、评价系统。

衡量一个详情页最重要的指标就是打开时长，从点击到页面渲染呈现 完毕，要花多少时间 。

这里同时涉及前后端技术，比如资源加载等，我这里主要考虑后端。   详情页后端其实仍然是多个后端系统组合的一个出口系统， 要分别拉库存量、价格、历史信息、评论等。  

为了降低压力 ，先拆，  比如评论，一般放在下半部分，使用懒加载技术，先呈现页面的主要元素，然后再加载，从用户的使用角度来看，几乎没有影响。



#### 搜索

用户从哪里查看商品？这个就是商业模式的流量来源，但少不了`首页推荐` `外部导流` `定向广告投放` `搜索`

#### 大型活动

电子商务经常会做各种各样的促销活动，需要保障稳定性。

活动的特点：流量涨、服务请求涨、客服请求涨。后端对涨就是缓、削、拆、扛。

一是缓，将大量可以提前的请求，分批提前下发，比如手Q红包活动，要下发一个红包资源文件，在前几个版本中预埋了相应逻辑，在活动开始前半个月就将资源分批下发到客户端，大大减少了活动时的瞬间值。

二是削，通过消息队列等组件，将原来的瞬间峰值，异步的缓慢处理，降低后端接口压力（支付等接口压力）

三是拆，将一个大的请求拆为多个小请求，各个小请求分而治之。同时，也要拆优先级，保障高优先级的核心功能，必要时放弃低优先级功能。 比如商品在必要时，可以停止评论，但不能停掉下单。

四是扛，必要的处理流量一定会涨起来，那么就要运维+开发+运营提前规划活动，预备资源（云时代，资源更方便了），业务高峰期快速扩容，扛住业务压力。 这也要求运维系统、开发协作，运营评估等有较好配合。

这方面市面上有很多经验之谈。

#### 商户管理

平台接入商户时，要提供相应的后台管理功能，用于商品维护、客服处理、订单导出、对账等等。

####数据分析

业务数据分析。DAU、MAU、活跃用户数、付费用户数、付费占比、ARUP、

#### 开放平台

规模做大后，可能会将业务数据通过第三方来接入，或者嵌入第三方。 由于不会直接暴露内部数据，一般是搭建开放平台，通过鉴权认证后，再将数据暴露出去。

#### 客服系统

必要的平台客服，与商户客服系统。


#### 商业化

商业公司要盈利，技术上也要考虑盈利因素

​	

## 监控

​	监控很重要，但要监控哪些信息呢？

​	

## 分而治之

计算机的很多事，能解决的就直接刚，不能解决的，那就叫一群小弟来`分而治之`

##杂谈
 [readline](https://en.wikipedia.org/wiki/GNU_Readline)

```

```